<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Stock & Invoice Management</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: lightslategray; }
h1, h2 { margin-bottom: 10px; }
button { padding: 6px 12px; margin-right: 6px; cursor: pointer; }
#top-buttons { margin-bottom: 12px; }
#search-bar { padding: 6px; width: 300px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background-color: #4CAF50; color: white; }
input[type="number"], select { width: 60px; text-align: center; font-weight:bold; }
img { max-width: 60px; max-height: 60px; }
.delete-btn { background: #dc3545; color: white; border: none; }
#invoice-editor { margin-top: 20px; display:none; background:#fff;padding:15px;border:1px solid #333; box-shadow:0 0 10px rgba(0,0,0,0.2);}
.invoice-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
#logo-preview { max-height:50px; max-width:120px; }
.signature-box { width:180px; height:60px; border:1px solid #333; display:inline-block; margin:5px; vertical-align:top; }
.invoice-table th, .invoice-table td { padding:6px; border:1px solid #333; }
.invoice-table tbody tr:nth-child(even){ background:#f9f9f9; }
.invoice-table tfoot td { font-weight:bold; }
button{
font-family: Verdana, Geneva, Tahoma, sans-serif;
text-align: center;
font-size: 12px;
margin: 0 15px;
cursor: pointer;
transition: all 0.3s ease;
}
.Button:hover{
background-color: gray;
color: white;
box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19);
}
.Button:active{
transform: translateY(4px);
}
@media print {
  body { margin: 0; }
  #top-buttons, #tab-stock, #tab-invoices, #invoice-editor button { display:none; }
  #invoice-editor { border:none; }
}
</style>
</head>
<body>

<h1>Admin Stock & Invoice Management</h1>

<div id="top-buttons">
  <button onclick="saveAllStocks()">Save Stocks</button>
  <button onclick="exportCSV()">Export Products CSV</button>
  <button onclick="switchTab('stock')">Stock Management</button>
  <button onclick="switchTab('invoices')">Invoice History</button>
  <input type="file" id="import-file" accept=".csv">
  <input type="text" id="search-bar" placeholder="Search by ID, Name, Category, Price, Color">
  <button onclick="startInvoice()">Add Selected Items</button>
</div>

<div id="tab-stock">
<table>
<thead>
<tr>
<th>Select</th>
<th>ID</th>
<th>Image</th>
<th>Name</th>
<th>Category</th>
<th>Price</th>
<th>Colors</th>
<th>Stock</th>
<th>Delete</th>
</tr>
</thead>
<tbody id="admin-body"></tbody>
</table>
</div>

<div id="invoice-editor">
<h2>Invoice Editor</h2>
<div class="invoice-header">
  <div>
    Company Name: <input type="text" id="company-name" placeholder="Your Company">
  </div>
  <div>
    Logo URL: <input type="text" id="company-logo" placeholder="Logo URL">
  </div>
</div>
<table id="invoice-table" class="invoice-table">
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Price</th>
<th>Color</th>
<th>Qty</th>
<th>Total</th>
<th>Remove</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td colspan="6">Subtotal</td><td id="subtotal">0</td>
</tr>
<tr>
<td colspan="6">VAT (20%)</td><td id="tva">0</td>
</tr>
<tr>
<td colspan="6">Total</td><td id="total">0</td>
</tr>
<tr>
<td colspan="7" style="padding-top:20px;">
<div style="display:flex; justify-content:space-between; margin-top:10px;">
<div>
<p>Client Signature:</p>
<div class="signature-box"></div>
</div>
<div>
<p>Company Signature:</p>
<div class="signature-box"></div>
</div>
</div>
</td>
</tr>
</tfoot>
</table>
<button onclick="validateInvoice()">Validate Invoice</button>
<button onclick="cancelInvoiceEditor()">Cancel</button>
</div>

<div id="tab-invoices" style="display:none;">
<h2>Invoice History</h2>
<table>
<thead>
<tr>
<th>Invoice #</th>
<th>Date</th>
<th>Client</th>
<th>Items</th>
<th>Total</th>
<th>TVA (20%)</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="invoice-body"></tbody>
</table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const ADMIN_PASSWORD="1234";
const TVA_RATE=0.2;
let products=[];
let invoices=[];
let currentInvoice=[];

function loadProducts(){ const s=localStorage.getItem("admin-products"); if(s) products=JSON.parse(s);}
function saveProducts(){ localStorage.setItem("admin-products",JSON.stringify(products));}
function loadInvoices(){ const s=localStorage.getItem("admin-invoices"); if(s) invoices=JSON.parse(s);}
function saveInvoices(){ localStorage.setItem("admin-invoices",JSON.stringify(invoices));}

const tbody=document.getElementById("admin-body");
function renderAdmin(filter=""){
  tbody.innerHTML="";
  filter=filter.toLowerCase();
  products.filter(p=>p.id.toLowerCase().includes(filter)||
                     p.name.toLowerCase().includes(filter)||
                     p.category.toLowerCase().includes(filter)||
                     p.price.toString().includes(filter)||
                     p.colors.join(", ").toLowerCase().includes(filter)
  ).forEach(p=>{
    const tr=document.createElement("tr");
    tr.style.background=p.stock===0?"#f8d7da":(p.stock<5?"#fff3cd":"#d4edda");
    tr.innerHTML=`
      <td><input type="checkbox" class="select-item" value="${p.id}"></td>
      <td>${p.id}</td>
      <td>${p.image?`<img src="${p.image}">`:''}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${p.price}</td>
      <td>${p.colors.join(", ")}</td>
      <td><input type="number" min="0" value="${p.stock}" id="stock-${p.id}"></td>
      <td><button class="delete-btn" onclick="deleteItem('${p.id}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function saveAllStocks(){
  products.forEach(p=>{ const i=document.getElementById(`stock-${p.id}`); if(i) p.stock=parseInt(i.value)||0; });
  saveProducts();
  renderAdmin(document.getElementById("search-bar").value);
  alert("Stocks saved!");
}

function deleteItem(id){
  const pass=prompt("Enter password:");
  if(pass!==ADMIN_PASSWORD) return alert("Wrong password!");
  if(!confirm("Delete this product?")) return;
  products=products.filter(p=>p.id!==id);
  saveProducts();
  renderAdmin(document.getElementById("search-bar").value);
}

function startInvoice(){
  const selected=[...document.querySelectorAll(".select-item:checked")].map(cb=>products.find(p=>p.id===cb.value));
  if(selected.length===0){ alert("Select items"); return; }
  selected.forEach(p=>{
    const color=p.colors[0]||"";
    currentInvoice.push({...p, quantity:1, selectedColor:color});
  });
  showInvoiceEditor();
}

function showInvoiceEditor(){ document.getElementById("invoice-editor").style.display="block"; renderInvoiceTable();}
function cancelInvoiceEditor(){ if(confirm("Cancel invoice?")) document.getElementById("invoice-editor").style.display="none"; }

function renderInvoiceTable(){
  const tbody=document.querySelector("#invoice-table tbody");
  tbody.innerHTML="";
  let subtotal=0;
  currentInvoice.forEach((i,index)=>{
    const tr=document.createElement("tr");
    const total=i.price*i.quantity;
    subtotal+=total;
    const colorOptions=i.colors.map(c=>`<option value="${c}" ${c===i.selectedColor?'selected':''}>${c}</option>`).join('');
    tr.innerHTML=`
      <td>${i.id}</td>
      <td>${i.name}</td>
      <td>${i.price}</td>
      <td><select onchange="updateInvoiceColor(${index},this.value)">${colorOptions}</select></td>
      <td><input type="number" min="1" value="${i.quantity}" onchange="updateInvoiceQty(${index},this.value)"></td>
      <td>${total.toFixed(2)}</td>
      <td><button onclick="removeInvoiceItem(${index})" class="delete-btn">Remove</button></td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("subtotal").textContent=subtotal.toFixed(2);
  document.getElementById("tva").textContent=(subtotal*TVA_RATE).toFixed(2);
  document.getElementById("total").textContent=(subtotal*(1+TVA_RATE)).toFixed(2);
}

function updateInvoiceQty(index,val){
  val=parseInt(val);
  if(val<1) val=1;
  if(val>currentInvoice[index].stock){ alert("Not enough stock!"); val=currentInvoice[index].stock; }
  currentInvoice[index].quantity=val;
  renderInvoiceTable();
}

function updateInvoiceColor(index,color){
  currentInvoice[index].selectedColor=color;
}

function removeInvoiceItem(index){
  currentInvoice.splice(index,1);
  renderInvoiceTable();
}

// ===== VALIDATE INVOICE =====
function validateInvoice(){
  if(currentInvoice.length===0){ alert("Invoice empty!"); return; }
  const invNumber=prompt("Invoice number:","INV-"+Date.now());
  const client=prompt("Client name:","Client");
  const company=document.getElementById("company-name").value||"Company";
  const logo=document.getElementById("company-logo").value||"";
  currentInvoice.forEach(i=>{
    const p=products.find(p=>p.id===i.id);
    if(p) p.stock-=i.quantity;
  });
  saveProducts();
  const subtotal=currentInvoice.reduce((s,i)=>s+i.price*i.quantity,0);
  const tva=subtotal*TVA_RATE;
  const invoice={number:invNumber,date:new Date().toLocaleString(),client,items:currentInvoice,subtotal,tva,total:subtotal+tva,company,logo};
  invoices.push(invoice);
  saveInvoices();
  currentInvoice=[];
  renderInvoices();
  renderAdmin(document.getElementById("search-bar").value);
  document.getElementById("invoice-editor").style.display="none";
  alert("Invoice saved!");
}

// ===== INVOICE HISTORY =====
const invBody=document.getElementById("invoice-body");
function renderInvoices(){
  invBody.innerHTML="";
  invoices.forEach(inv=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.client}</td>
      <td>${inv.items.map(i=>i.name+" x"+i.quantity+" ("+i.selectedColor+")").join("<br>")}</td>
      <td>${inv.total.toFixed(2)}</td>
      <td>${inv.tva.toFixed(2)}</td>
      <td>
        <button onclick="printInvoice('${inv.number}')">Print</button>
        <button onclick="cancelInvoiceHistory('${inv.number}')">Cancel</button>
        <button onclick="deleteInvoiceWithoutStock('${inv.number}')">Delete w/o Stock</button>
      </td>
    `;
    invBody.appendChild(tr);
  });
}

function cancelInvoiceHistory(number){
  const pass=prompt("Password:");
  if(pass!==ADMIN_PASSWORD) return alert("Wrong password");
  const inv=invoices.find(i=>i.number===number);
  if(!inv) return;
  if(!confirm("Cancel invoice? Stock will be restored.")) return;
  inv.items.forEach(i=>{
    const p=products.find(p=>p.id===i.id);
    if(p) p.stock+=i.quantity;
  });
  invoices=invoices.filter(i=>i.number!==number);
  saveInvoices();
  saveProducts();
  renderInvoices();
  renderAdmin();
}

function deleteInvoiceWithoutStock(number){
  const pass=prompt("Password:");
  if(pass!==ADMIN_PASSWORD) return alert("Wrong password");
  if(!confirm("Delete invoice permanently? Stock will NOT be restored.")) return;
  invoices=invoices.filter(i=>i.number!==number);
  saveInvoices();
  renderInvoices();
}

function printInvoice(number){
  const inv=invoices.find(i=>i.number===number);
  if(!inv) return;
  let html=`<div style="border-bottom:2px solid #333;margin-bottom:10px;padding:10px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>${inv.company}</h2>
      <img src="${inv.logo}" style="max-height:50px; max-width:120px;">
    </div>
    <p>Invoice #: ${inv.number}<br>Client: ${inv.client}<br>Date: ${inv.date}</p>
  </div>`;
  html+=`<table border="1" width="100%" cellpadding="5" class="invoice-table">
    <tr><th>ID</th><th>Name</th><th>Color</th><th>Qty</th><th>Price</th><th>Total</th></tr>`;
  inv.items.forEach(i=>{
    html+=`<tr>
      <td>${i.id}</td><td>${i.name}</td><td>${i.selectedColor}</td><td>${i.quantity}</td><td>${i.price}</td><td>${(i.price*i.quantity).toFixed(2)}</td>
    </tr>`;
  });
  html+=`<tfoot>
    <tr><td colspan="5">Subtotal</td><td>${inv.subtotal.toFixed(2)}</td></tr>
    <tr><td colspan="5">VAT (20%)</td><td>${inv.tva.toFixed(2)}</td></tr>
    <tr><td colspan="5">Total</td><td>${inv.total.toFixed(2)}</td></tr>
    <tr><td colspan="6" style="padding-top:20px;">
      <div style="display:flex; justify-content:space-between;">
        <div>
          <p>Client Signature:</p>
          <div class="signature-box"></div>
        </div>
        <div>
          <p>Company Signature:</p>
          <div class="signature-box"></div>
        </div>
      </div>
    </td></tr>
  </tfoot>`;
  html+=`</table><button onclick="window.print()">Print</button>`;
  const win=window.open("","_blank");
  win.document.write(html);
  win.document.close();
}

function switchTab(tab){
  document.getElementById("tab-stock").style.display=tab==="stock"?"block":"none";
  document.getElementById("tab-invoices").style.display=tab==="invoices"?"block":"none";
}

function exportCSV(){
  let csv="ID,Name,Category,Price,Stock,Colors,Image\n";
  products.forEach(p=>csv+=`"${p.id}","${p.name}","${p.category}",${p.price},${p.stock},"${p.colors.join("|")}","${p.image}"\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="products.csv"; a.click();
}

document.getElementById("import-file").addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file) return;
  Papa.parse(file,{header:true,skipEmptyLines:true,
    complete:res=>{
      res.data.forEach(row=>{
        if(!row.ID) return;
        const colors=row.Colors?row.Colors.split("|").map(c=>c.trim()):[];
        const item={
          id:row.ID.trim(),
          name:row.Name||"Unnamed",
          category:row.Category||"Uncategorized",
          price:Number(row.Price)||0,
          stock:Number(row.Stock)||0,
          colors,
          image:row.Image||""
        };
        const existing=products.find(p=>p.id===item.id);
        if(existing) Object.assign(existing,item);
        else products.push(item);
      });
      saveProducts(); renderAdmin(); alert("CSV imported");
    }
  });
});

document.getElementById("search-bar").addEventListener("input",()=>renderAdmin(document.getElementById("search-bar").value));

loadProducts(); loadInvoices(); renderAdmin(); renderInvoices();
</script>
</body>
</html>
