<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NaggyStore Admin – Stock & Factures</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* GLOBAL STYLES */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f1f3f6;
            color: #000;
        }

        h1,
        h2 {
            margin: 0 0 10px 0;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 12px;
            font-family: Verdana, sans-serif;
        }

        /* BUTTONSs */
        button {
            text-align: center;
            font-size: 13px;
            margin: 0 5px 5px 0;
            padding: 8px 14px;
            border-radius: 6px;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #43a047;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .cancel-btn {
            background-color: #ff9800;
        }

        .cancel-btn:hover {
            background-color: #e68900;
        }

        #top-buttons button {
            margin-bottom: 6px;
        }

        /* LAYOUT */
        #search-bar,
        #invoice-search-bar {
            width: 250px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            height: calc(100vh - 80px);
        }

        .stock-panel,
        #tab-stock,
        .invoice-panel,
        #invoice-editor,
        #tab-invoices {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stock-panel h2,
        #tab-stock h2,
        .invoice-panel h2,
        #invoice-editor h2 {
            padding: 10px;
            background: #4CAF50;
            color: white;
            border-radius: 4px 4px 0 0;
            margin: -15px -15px 15px -15px;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 13px;
        }

        thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            color: #333;
            z-index: 2;
            border-bottom: 2px solid #ddd;
        }

        img {
            max-width: 50px;
            max-height: 50px;
            object-fit: contain;
        }

        /* INVOICE EDITOR SPECIFIC */
        .invoice-panel {
            overflow-y: auto;
        }

        .editor-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .editor-fields label {
            display: flex;
            flex-direction: column;
            font-size: 12px;
            font-weight: bold;
            color: #555;
        }

        .editor-fields input,
        .editor-fields textarea,
        .editor-fields select {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 4px;
        }

        .editor-fields textarea {
            resize: vertical;
            min-height: 40px;
            font-family: inherit;
        }

        .field-group {
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 6px;
            background: #fafafa;
        }

        .field-group h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #4CAF50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        #logo-preview {
            max-height: 60px;
            max-width: 150px;
            border: 1px solid #eee;
            padding: 2px;
            background: #fff;
            margin-top: 5px;
            display: block;
        }

        .signature-box {
            width: 100%;
            height: 60px;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            color: #999;
            font-size: 11px;
        }

        /* INVOICE TABLE IN EDITOR */
        .invoice-table th {
            background: #eee;
            font-size: 12px;
        }

        .invoice-table td {
            padding: 4px;
            font-size: 12px;
        }

        .invoice-table input,
        .invoice-table select {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* TOTALS BOXss */
        .total-box {
            border: 2px solid #333;
            padding: 15px;
            width: 300px;
            margin-top: 15px;
            text-align: right;
            font-weight: bold;
            background: #fff;
            margin-left: auto;
        }

        .total-box span {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .total-separator {
            border-top: 2px solid #333;
            margin: 5px 0;
            padding-top: 5px;
            font-size: 16px;
        }

        /* PRINT STYLES */
        @page {
            size: A4;
            margin: 10mm;
        }

        @media print {
            body {
                background: white;
                font-size: 11px;
                margin: 0;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            #top-buttons,
            .stock-panel,
            #tab-invoices,
            button,
            h1 {
                display: none !important;
            }

            .admin-layout {
                display: block;
                height: auto;
                padding: 0;
            }

            .invoice-panel,
            #invoice-editor {
                border: none;
                padding: 0;
                box-shadow: none;
                overflow: visible;
                display: block !important;
            }

            /* Hide editor UI controls when printing directly if ever needed, but we use a separate print window */
        }
    </style>
</head>

<body>

    <h1 style="padding:10px 15px; background:#fff; border-bottom:1px solid #ddd; margin:0;">Gestion Admin - Stock et
        Factures</h1>
    <div id="top-buttons"
        style="padding:15px; background:#fff; border-bottom:1px solid #eee; display:flex; flex-wrap:wrap; align-items:center; gap:6px;">
        <span id="firebase-status" style="font-size:12px; color:#4CAF50; font-weight:600; margin-right:6px;">🟢 Checking...
        </span>
        <button onclick="saveAllStocks()">Enregistrer les stocks</button>
        <button onclick="exportCSV()">Exporter (CSV)</button>
        <button onclick="switchTab('stock')">Stock</button>
        <button onclick="switchTab('invoices')">Historique des factures</button>
        <input type="file" id="import-file" accept=".csv,.txt,.tsv,.xlsx,.xls" style="font-size:12px;">
        <span
            style="margin:0 4px; border-left:1px solid #ccc; height:20px; display:inline-block; vertical-align:middle;"></span>
        <input type="text" id="search-bar" placeholder="Rechercher des produits...">
        <button onclick="startInvoice()" style="background:#2196F3;">Ajouter une facture</button>
        <input type="text" id="invoice-search-bar" placeholder="Rechercher des factures...">
        <span style="flex:1;"></span>
        <button onclick="(function() { console.log('Navigating to admin-users.html'); window.location.href='admin-users.html'; })()" style="background:#9c27b0;">👥 Manage Users</button>
        <button onclick="doLogout()" style="background:#f44336;">👋 Logout</button>
    </div>

    <div class="admin-layout">
        <!-- STOCK TAB -->
        <div class="stock-panel" id="tab-stock">
            <h2>Stock Management</h2>
            <div style="overflow:auto; flex:1;">
                <table>
                    <thead>
                        <tr>
                            <th width="40">SÃ©lectionner</th>
                            <th width="80">ID</th>
                            <th width="60">Image</th>
                            <th>Nom</th>
                            <th>CatÃ©gorie</th>
                            <th>Prix</th>
                            <th>Couleurs</th>
                            <th width="60">Stock</th>
                            <th width="60">Action</th>
                        </tr>
                    </thead>
                    <tbody id="admin-body"></tbody>
                </table>
            </div>
        </div>

        <!-- INVOICE EDITOR -->
        <div class="invoice-panel" id="invoice-editor" style="display:none;">
            <h2>Éditeur de facture</h2>

            <!-- Top Meta -->
            <div
                style="display:flex; justify-content:space-between; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:4px;">
                <div>
                    <label style="font-weight:bold; font-size:12px;">ID facture :</label>
                    <input type="text" id="invoice-id" readonly
                        style="border:none; background:transparent; font-weight:bold; color:#4CAF50;">
                </div>
                <div style="text-align:right;">
                    <button class="delete-btn" onclick="cancelInvoiceEditor()"
                        style="padding:4px 8px; font-size:11px;">Fermer
                        Editor</button>
                </div>
            </div>

            <div style="display:flex; gap:15px; margin-bottom:15px;">
                <!-- Company Info -->
                <div class="field-group" style="flex:1;">
                    <h3>Détails de l'entreprise</h3>
                    <div class="editor-fields">
                        <label>Nom<input type="text" id="company-name" placeholder="Nom de l'entreprise"></label>
                        <label>TÃ©lÃ©phone<input type="text" id="company-phone" placeholder="TÃ©lÃ©phone"></label>
                        <label>Adresse<input type="text" id="company-address" placeholder="Adresse"></label>
                        <label>Fax<input type="text" id="company-fax" placeholder="Fax"></label>
                        <label>Email<input type="text" id="company-email" placeholder="Email"></label>
                        <label>Site web<input type="text" id="company-website" placeholder="Site web"></label>
                        <label>Identifiant fiscal (MF)<input type="text" id="company-mf" placeholder="MF"></label>
                        <label>RC<input type="text" id="company-rc" placeholder="RC"></label>
                        <label>RIB<input type="text" id="company-rib" placeholder="RIB"></label>
                        <label>URL du logo<input type="text" id="company-logo" placeholder="http://..."></label>
                    </div>
                    <img id="logo-preview" alt="Aperçu du logo">
                </div>

                <!-- Client Info -->
                <div class="field-group" style="flex:1;">
                    <h3>Détails du client</h3>
                    <div class="editor-fields">
                        <label>Nom du client<input type="text" id="client-name" placeholder="Nom du client"></label>
                        <label>TÃ©lÃ©phone<input type="text" id="client-phone" placeholder="TÃ©lÃ©phone"></label>
                        <label>Adresse<textarea id="client-address" placeholder="Adresse"></textarea></label>
                        <label>Code client<input type="text" id="client-code" placeholder="Code"></label>
                        <label>MF / CIN<input type="text" id="client-mfcin" placeholder="MF ou CIN"></label>
                        <label>RÃ©f. facture<input type="text" id="client-ref" placeholder="RÃ©fÃ©rence"></label>
                    </div>
                    <div style="margin-top:10px; border-top:1px solid #eee; padding-top: -2px;">
                        <label style="font-size:12px; font-weight:bold;">Mode de paiement</label>
                        <select id="payment-mode"
                            style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:3px;">
                            <option value="CAISSE">CAISSE</option>
                            <option value="CHÃˆQUE">CHÃˆQUE</option>
                            <option value="VIREMENT">VIREMENT</option>
                            <option value="ESPÈCES">ESPÈCES</option>
                            <option value="A TERME">A TERME</option>
                        </select>
                    </div>
                    <div style="margin-top:10px;">
                        <label style="font-size:12px; font-weight:bold;">ChargÃ©(e)</label>
                        <input type="text" id="charged-to" placeholder="Nom"
                            style="width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:3px;">
                    </div>
                </div>
            </div>

            <!-- Items Table -->
            <div style="overflow:auto; border:1px solid #ccc; border-radius:4px; margin-bottom:15px;">
                <table class="invoice-table" id="invoice-table">
                    <thead>
                        <tr>
                            <th width="15%">Réf</th>
                            <th width="25%">Article</th>
                            <th width="10%">Couleur</th>
                            <th width="8%">Qté</th>
                            <th width="10%">PU TTC</th>
                            <th width="8%">Remise %</th>
                            <th width="10%">Montant</th>
                            <th width="8%">TVA %</th>
                            <th width="5%">Suppr</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="display:flex; gap:15px;">
                <!-- Fees -->
                <div class="field-group" style="flex:1;">
                    <h3>Frais & ajustements</h3>
                    <div class="editor-fields" style="grid-template-columns:1fr 1fr 1fr;">
                        <label>Transport<input type="number" step="0.001" id="fee-transport" value="0"></label>
                        <label>Installation<input type="number" step="0.001" id="fee-installation" value="0"></label>
                        <label>Frais<input type="number" step="0.001" id="fee-frais" value="0"></label>
                        <label>Retenue<input type="number" step="0.001" id="fee-retenue" value="0"></label>
                        <label>Garantie<input type="number" step="0.001" id="fee-garantie" value="0"></label>
                        <label>Timbre Fiscal<input type="number" step="0.001" id="timbre-fiscal" value="1.000"></label>
                    </div>
                </div>

                <!-- Totals -->
                <div class="total-box">
                    <span>Sous-total HT: <b id="subtotal">0.000</b></span>
                    <span>Total TVA: <b id="tva">0.000</b></span>
                    <span>Frais: <b id="fees-total">0.000</b></span>
                    <span>Timbre: <b id="timbre-display">1.000</b></span>
                    <div class="total-separator">
                        <span>Net à payer (TTC): <b id="total" style="font-size:18px;">0.000 DNT</b></span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div
                style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end; border-top:1px solid #eee; padding-top:15px;">
                <button onclick="cancelInvoiceEditor()" class="cancel-btn">Cancel</button>
                <button onclick="validateInvoice()" style="padding:10px 25px; font-size:14px;">Validate & Save
                    Invoice</button>
            </div>
        </div>

        <!-- INVOICE HISTORY TAB -->
        <div id="tab-invoices" style="display:none;">
            <h2>Historique des Factures</h2>
            <div style="overflow:auto; flex:1;">
                <table>
                    <thead>
                        <tr>
                            <th>Facture #</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Items</th>
                            <th>Montant TTC</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-body"></tbody>
                </table>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
        <script src="assets/xlsx.full.min.js"></script>
        <script type="module">
            // =============================================
            // FIREBASE INTEGRATION
            // =============================================
            import { auth, db, ADMIN_EMAIL, persistenceReady } from "./firebase-config.js";
            import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
            import {
                collection, doc,
                getDocs, getDoc, setDoc, updateDoc, deleteDoc,
                onSnapshot, serverTimestamp, query, orderBy, where
            } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";


            // --- CONFIG & STATE ---
            const ADMIN_PASSWORD = "1234";
            let products = [], invoices = [], currentInvoice = [];
            let editMode = false;
            let editingInvoiceIndex = -1;

            // Wait for persistence to initialize
            await persistenceReady;

            // --- AUTH GUARD ---
            onAuthStateChanged(auth, async (user) => {
                if (!user) { window.location.href = 'login.html'; return; }

                try {
                    const userSnap = await getDoc(doc(db, "users", user.uid));
                    if (!userSnap.exists() || userSnap.data().role !== 'admin') {
                        alert("Access denied. Admin only.");
                        await signOut(auth);
                        window.location.href = 'login.html';
                        return;
                    }
                } catch (err) {
                    console.warn("Admin auth check error (likely offline):", err);
                    // If offline and we're already here, assume authorized admin based on local session
                    // We can check if email matches ADMIN_EMAIL as an extra hint
                    if (user.email !== ADMIN_EMAIL) {
                        window.location.href = 'login.html'; return;
                    }
                }
                init();
            });

            window.doLogout = async function () {
                await signOut(auth);
                window.location.href = 'login.html';
            };

            // --- INITIALIZATION ---
            function init() {
                console.log("🚀 Admin panel initialization started...");
                
                // Library Check
                const missing = [];
                if (typeof Papa === 'undefined') missing.push("PapaParse (CSV)");
                if (typeof XLSX === 'undefined') missing.push("SheetJS (Excel)");

                if (missing.length > 0) {
                    alert("Attention: Certaines librairies sont manquantes (" + missing.join(", ") + ").\nL'import pourrait ne pas fonctionner hors ligne.");
                }

                // Load data from Firestore
                console.log("📡 Loading data from Firestore...");
                loadFromFirestore();
                console.log("✅ Firestore listeners set up");

                // Logos
                const logoInput = document.getElementById("company-logo");
                if (logoInput) {
                    logoInput.addEventListener("input", e => {
                        document.getElementById("logo-preview").src = e.target.value;
                    });
                }

                // Search
                const searchBar = document.getElementById("search-bar");
                if (searchBar) {
                    searchBar.addEventListener("input", () => {
                        renderStockTable(document.getElementById("search-bar").value);
                    });
                }
                
                const invoiceSearchBar = document.getElementById("invoice-search-bar");
                if (invoiceSearchBar) {
                    invoiceSearchBar.addEventListener("input", renderInvoiceHistory);
                }

                // Fee Listeners for live update
                ["fee-transport", "fee-installation", "fee-frais", "fee-retenue", "fee-garantie", "timbre-fiscal"].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener("input", renderInvoiceEditorTable);
                });

                // Connection monitoring
                window.addEventListener('online', updateConnectionStatus);
                window.addEventListener('offline', updateConnectionStatus);
                updateConnectionStatus();
                
                console.log("✅ Admin panel ready!");
            }

            function updateConnectionStatus() {
                const status = document.getElementById('firebase-status');
                if (!status) return;
                if (navigator.onLine) {
                    status.textContent = '🟢 Online';
                    status.style.color = '#4CAF50';
                } else {
                    status.textContent = '🟡 Offline (Local Cache)';
                    status.style.color = '#ff9800';
                }
            }

            // --- STOCK MANAGEMENT ---
            // --- FIRESTORE DATA LAYER ---
            async function loadFromFirestore() {
                try {
                    onSnapshot(collection(db, "products"), (snap) => {
                        products = [];
                        snap.forEach(d => {
                            const data = d.data();
                            data._docId = d.id;
                            if (data.id) data.id = String(data.id);
                            products.push(data);
                        });
                        console.log("✅ Products loaded from Firestore:", products.length);
                        renderStockTable();
                        document.getElementById('firebase-status').textContent = '✅ Synced';
                        document.getElementById('firebase-status').style.color = '#4CAF50';
                    }, (err) => {
                        console.error('Products Snapshot error:', err);
                        document.getElementById('firebase-status').textContent = '❌ Error';
                        document.getElementById('firebase-status').style.color = '#f44336';
                    });
                    onSnapshot(collection(db, "invoices"), (snap) => {
                        invoices = [];
                        snap.forEach(d => {
                            const data = d.data();
                            data._docId = d.id;
                            invoices.push(data);
                        });
                        console.log("✅ Invoices loaded from Firestore:", invoices.length);
                        renderInvoiceHistory();
                    }, (err) => {
                        console.error('Invoices Snapshot error:', err);
                    });
                } catch (e) {
                    console.error('Firestore load error:', e);
                    document.getElementById('firebase-status').textContent = '❌ Offline';
                    document.getElementById('firebase-status').style.color = '#f44336';
                }
            }

            // Helper: Sanitize doc IDs (remove slashes and special chars)
            function sanitizeDocId(id) {
                return String(id).replace(/[^a-zA-Z0-9-_]/g, '_').substring(0, 255);
            }

            // Helper: Find user UID by email
            async function findUserByEmail(email) {
                if (!email) return null;
                try {
                    const q = query(collection(db, "users"), where("email", "==", email.toLowerCase()));
                    const snap = await getDocs(q);
                    if (!snap.empty) return snap.docs[0].id;
                } catch (e) {
                    console.warn("Error finding user by email:", e);
                }
                return null;
            }

            async function saveProducts() {
                try {
                    // Clone array to avoid race condition with Firestore listener
                    const productsCopy = [...products];
                    console.log("💾 Saving", productsCopy.length, "products to Firestore...");
                    
                    // Batch all saves together to avoid listener interference
                    const savePromises = productsCopy.map(p => {
                        const docId = p._docId || sanitizeDocId(p.id);
                        return setDoc(doc(db, "products", String(docId)), {
                            id: p.id, name: p.name, category: p.category,
                            price: p.price, stock: p.stock,
                            colors: p.colors || [], image: p.image || ''
                        }).then(() => {
                            // Update original product's _docId if it still exists
                            const origProduct = products.find(prod => prod.id === p.id);
                            if (origProduct) {
                                origProduct._docId = String(docId);
                            }
                        });
                    });
                    
                    await Promise.all(savePromises);
                    console.log("✅ All products saved to Firebase successfully");
                    document.getElementById('firebase-status').textContent = '✅ Saved';
                    document.getElementById('firebase-status').style.color = '#4CAF50';
                } catch (e) {
                    console.error("Save error:", e);
                    alert('Cloud save error: ' + e.message);
                    document.getElementById('firebase-status').textContent = '❌ Save Failed';
                    document.getElementById('firebase-status').style.color = '#f44336';
                }
            }

            async function saveInvoices() {
                // Invoices are saved individually via validateInvoice()
            }

            async function saveOneInvoice(invData) {
                const docId = sanitizeDocId(invData.number);
                const toSave = { ...invData };
                delete toSave._docId;
                toSave.savedAt = serverTimestamp();
                
                // Look up client UID by email to enable client-side filtering
                if (toSave.clientEmail) {
                    const clientUid = await findUserByEmail(toSave.clientEmail);
                    if (clientUid) {
                        toSave.clientUid = clientUid;
                        console.log("✅ Invoice linked to client UID:", clientUid);
                    } else {
                        console.warn("⚠️ Could not find user with email:", toSave.clientEmail);
                    }
                }
                
                await setDoc(doc(db, "invoices", docId), toSave);
                invData._docId = docId;
            }

            function renderStockTable(filter = "") {
                const tbody = document.getElementById("admin-body");
                tbody.innerHTML = "";
                filter = filter.toLowerCase();

                products.filter(p =>
                    String(p.id).toLowerCase().includes(filter) ||
                    String(p.name).toLowerCase().includes(filter) ||
                    String(p.category).toLowerCase().includes(filter)
                ).forEach(p => {
                    const tr = document.createElement("tr");
                    tr.style.background = p.stock === 0 ? "#fff0f0" : (p.stock < 5 ? "#fffbef" : "#f0fff4");

                    // Safety for fields
                    const img = p.image ? `<img src="${p.image}">` : '';
                    const colors = Array.isArray(p.colors) ? p.colors.join(", ") : p.colors;

                    tr.innerHTML = `
      <td><input type="checkbox" class="select-item" value="${p.id}"></td>
      <td>${p.id}</td>
      <td>${img}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${Number(p.price).toFixed(3)}</td>
      <td>${colors}</td>
      <td><input type="number" id="stock-${p.id}" value="${p.stock}" style="width:60px;"></td>
      <td>
        <button onclick="addToInvoice('${p.id}')" title="Ajouter Ã  la facture" style="background:#2196F3; padding:4px 8px; margin-right:5px;">+</button>
        <button class="delete-btn" onclick="deleteProduct('${p.id}')">Suppr</button>
      </td>
    `;
                    tbody.appendChild(tr);
                });
            }

            async function saveAllStocks() {
                products.forEach(p => {
                    const el = document.getElementById(`stock-${p.id}`);
                    if (el) p.stock = parseInt(el.value) || 0;
                });
                await saveProducts();
                alert("Stocks mis Ã  jour et sauvegardÃ©s dans le cloud!");
            }

            async function deleteProduct(id) {
                if (prompt("Password:") !== ADMIN_PASSWORD) return alert("Wrong password");
                if (!confirm("Delete this product?")) return;
                const p = products.find(x => x.id === id);
                if (p) {
                    try {
                        const docId = p._docId || p.id;
                        await deleteDoc(doc(db, "products", String(docId)));
                    } catch (e) { console.error(e); }
                }
                products = products.filter(p => p.id !== id);
                renderStockTable();
            }

            // --- CSV/EXCEL IMPORT/EXPORT ---
            function exportCSV() {
                let csv = "ID,Name,Category,Price,Stock,Colors,Image\n";
                products.forEach(p => {
                    const cols = Array.isArray(p.colors) ? p.colors.join("|") : p.colors;
                    csv += `"${p.id}","${p.name}","${p.category}",${p.price},${p.stock},"${cols}","${p.image}"\n`;
                });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
                a.download = "products_export.csv";
                a.click();
            }

            document.getElementById("import-file").addEventListener("change", async e => {
                const file = e.target.files[0];
                if (!file) return;

                // Reset value so change event fires again if same file selected
                e.target.value = '';

                const filename = file.name.toLowerCase();
                let importedData = [];
                let failureMessage = "";

                // 1. DATA EXTRACTION
                try {
                    if (filename.endsWith('.xlsx') || filename.endsWith('.xls')) {
                        // Excel Logic
                        if (typeof XLSX === 'undefined') throw new Error("Erreur: Librairie Excel non chargÃ©e.");
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data);
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];

                        // Simple Header Detection
                        const rawInfo = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // Array of arrays
                        let headerIdx = 0;
                        // Find row with "Identifiant" or "ID"
                        for (let i = 0; i < Math.min(rawInfo.length, 25); i++) {
                            const str = (JSON.stringify(rawInfo[i]) || "").toLowerCase();
                            if (str.includes("identifiant") || str.includes("code") || (str.includes("id") && str.length < 200)) {
                                headerIdx = i;
                                break;
                            }
                        }
                        importedData = XLSX.utils.sheet_to_json(sheet, { range: headerIdx, defval: "" });

                    } else {
                        // CSV Logic (Simpler)
                        const text = await new Promise(resolve => {
                            const r = new FileReader();
                            r.onload = evt => resolve(evt.target.result);
                            r.readAsText(file); // Default encoding
                        });

                        // Try different delimiters: comma, semicolon, tab
                        const parse = (delim) => Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: delim });
                        let res = parse(",");
                        if (!res.data || res.data.length === 0 || Object.keys(res.data[0]).length < 2) res = parse(";");
                        if (!res.data || res.data.length === 0 || Object.keys(res.data[0]).length < 2) res = parse("\t");

                        importedData = res.data || [];
                        console.log("📊 Parsed", importedData.length, "rows from CSV");
                    }
                } catch (err) {
                    console.error(err);
                    return alert("Erreur extraction fichier: " + err.message);
                }

                if (!importedData.length) return alert("Fichier vide ou format non reconnu.");

                // 2. NORMALIZATION & IMPORT
                let successCount = 0;
                let failCount = 0;
                const debugKeys = Object.keys(importedData[0] || {});
                console.log("📥 Starting import of", importedData.length, "rows. Headers:", debugKeys);

                try {
                    importedData.forEach((raw, rowIdx) => {
                        // Normalize Helper
                        const get = (keys) => {
                            for (const k of keys) {
                                if (raw[k] !== undefined) return raw[k];
                                // Try lowercase/normalized keys
                                for (const rawKey in raw) {
                                    const n = rawKey.trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                                    if (n === k) return raw[rawKey];
                                }
                            }
                            return "";
                        };

                        const id = (get(["id", "identifiant", "code", "ref"]) || "").toString().trim();
                        if (!id) { failCount++; console.warn("❌ Row", rowIdx, "skipped: no ID found"); return; }

                        const name = (get(["name", "nom", "article", "designation"]) || "Produit").toString().trim();
                        const cat = (get(["category", "categorie", "famille"]) || "General").toString().trim();

                        let priceStr = (get(["price", "prix", "montant"]) || "0").toString().replace(",", ".");
                        const price = parseFloat(priceStr) || 0;

                        let stockStr = (get(["stock", "quantite", "qte"]) || "0").toString().replace(",", ".");
                        const stock = parseInt(stockStr) || 0;

                        // Colors
                        let colorVal = get(["colors", "couleurs", "color", "couleur"]);
                        let colorArr = [];
                        if (Array.isArray(colorVal)) colorArr = colorVal;
                        else if (typeof colorVal === 'string') {
                            if (colorVal.includes("|")) colorArr = colorVal.split("|");
                            else if (colorVal.includes(",")) colorArr = colorVal.split(",");
                            else colorArr = [colorVal];
                        }
                        colorArr = colorArr.map(c => c.trim()).filter(c => c);

                        const img = (get(["image", "url", "photo"]) || "").toString().trim();

                        // Merge
                        const existing = products.find(p => p.id === id);
                        const pObj = { id, name, category: cat, price, stock, colors: colorArr, image: img };

                        if (existing) {
                            Object.assign(existing, pObj);
                            console.log("✏️ Row", rowIdx, "- Updated:", id);
                        } else {
                            products.push(pObj);
                            console.log("✅ Row", rowIdx, "- Added:", id);
                        }
                        successCount++;
                    });

                    console.log("📊 Before saveProducts():", successCount, "items in products array");
                    await saveProducts();
                    console.log("📊 After saveProducts():", products.length, "items in products array");
                    renderStockTable();

                    let msg = "Import réussi: " + successCount + " produits sauvegardés dans le cloud ☁️.";
                    if (failCount > 0) msg += "\n(" + failCount + " lignes ignorées sans ID)";
                    if (successCount === 0) {
                        msg += "\n\nColonnes trouvées: " + debugKeys.join(", ");
                        msg += "\n(Vérifiez que la colonne ID/Identifiant existe)";
                    }
                    alert(msg);


                } catch (e) {
                    alert("Erreur traitement données: " + e.message);
                }
            });

            // --- INVOICE EDITOR LOGIC ---
            function switchTab(tab) {
                if (tab === "stock") {
                    document.getElementById("tab-stock").style.display = "flex";
                    document.getElementById("tab-invoices").style.display = "none";
                    // If invoice editor was open, keep it open (side-by-side)
                    // If not, it stays hidden
                } else if (tab === "invoices") {
                    document.getElementById("tab-stock").style.display = "none";
                    document.getElementById("invoice-editor").style.display = "none";
                    document.getElementById("tab-invoices").style.display = "flex";
                }
            }

            function addToInvoice(id) {
                const p = products.find(prod => prod.id === id);
                if (!p) return;

                let pColors = p.colors;
                if (typeof pColors === 'string') {
                    // Basic split, can be improved
                    pColors = pColors.split(/[,|]/).map(c => c.trim()).filter(c => c);
                } else if (!Array.isArray(pColors)) {
                    pColors = [];
                }

                currentInvoice.push({
                    ...p,
                    colors: pColors,
                    quantity: 1,
                    selectedColor: pColors[0] || "",
                    tvaRate: 19,
                    discount: 0
                });

                document.getElementById("tab-stock").style.display = "flex";
                document.getElementById("tab-invoices").style.display = "none";
                document.getElementById("invoice-editor").style.display = "flex";

                if (!document.getElementById("invoice-id").value) {
                    document.getElementById("invoice-id").value = "INV-" + Date.now();
                }
                renderInvoiceEditorTable();
            }

            function startInvoice() {
                const checks = document.querySelectorAll(".select-item:checked");
                let addedCount = 0;
                checks.forEach(c => {
                    const p = products.find(prod => String(prod.id) === String(c.value));
                    if (p) {
                        currentInvoice.push({
                            ...p,
                            quantity: 1,
                            selectedColor: (p.colors && p.colors[0]) ? p.colors[0] : "",
                            tvaRate: 19,
                            discount: 0
                        });
                        addedCount++;
                        c.checked = false;
                    }
                });
                document.getElementById("tab-stock").style.display = "flex";
                document.getElementById("tab-invoices").style.display = "none";
                document.getElementById("invoice-editor").style.display = "flex";
                if (!document.getElementById("invoice-id").value) {
                    document.getElementById("invoice-id").value = "INV-" + Date.now();
                }
                renderInvoiceEditorTable();
            }

            function renderInvoiceEditorTable() {
                const tbody = document.querySelector("#invoice-table tbody");
                tbody.innerHTML = "";

                let totalHT = 0;
                let totalTVA = 0;

                currentInvoice.forEach((item, idx) => {
                    // Math: 
                    // Price is assumed TTC (based on prompt "PU TTC").
                    // Amount (Montant) = Price * Qty * (1 - Disc/100).
                    // Base HT = Amount / (1 + TVA/100).
                    // TVA Val = Amount - Base HT.

                    // HOWEVER, typical B2B invoices often work with HT price. 
                    // Reference image has columns: PU TTC, Montant (TTC by implication if PU is TTC? Or HT?).
                    // Usually "Montant" column is the row total. 
                    // If PU is TTC, then Montant is TTC.
                    // Then the tax summary breaks it down.

                    const qty = parseInt(item.quantity) || 1;
                    const price = parseFloat(item.price) || 0; // TTC
                    const disc = parseFloat(item.discount) || 0;
                    const tvaRate = parseFloat(item.tvaRate) || 19;

                    const rowTotal = price * qty * (1 - disc / 100);

                    const baseHT = rowTotal / (1 + tvaRate / 100);
                    const tvaVal = rowTotal - baseHT;

                    totalHT += baseHT;
                    totalTVA += tvaVal;

                    const tr = document.createElement("tr");

                    const colorOpts = (Array.isArray(item.colors) ? item.colors : []).map(c =>
                        `<option value="${c}" ${c === item.selectedColor ? "selected" : ""}>${c}</option>`
                    ).join("");

                    tr.innerHTML = `
      <td>${item.id}</td>
      <td>${item.name}</td>
      <td><select onchange="updateInvItem(${idx}, 'color', this.value)">${colorOpts}</select></td>
      <td><input type="number" min="1" value="${qty}" onchange="updateInvItem(${idx}, 'qty', this.value)"></td>
      <td>${price.toFixed(3)}</td>
      <td><input type="number" min="0" max="100" value="${disc}" onchange="updateInvItem(${idx}, 'disc', this.value)"></td>
      <td><b>${rowTotal.toFixed(3)}</b></td>
      <td><input type="number" value="${tvaRate}" onchange="updateInvItem(${idx}, 'tva', this.value)"></td>
      <td><button class="delete-btn" onclick="removeInvItem(${idx})" style="padding:2px 6px;">x</button></td>
    `;
                    tbody.appendChild(tr);
                });

                // Fees
                const transport = parseFloat(document.getElementById("fee-transport").value) || 0;
                const installation = parseFloat(document.getElementById("fee-installation").value) || 0;
                const frais = parseFloat(document.getElementById("fee-frais").value) || 0;
                const retenue = parseFloat(document.getElementById("fee-retenue").value) || 0;
                const garantie = parseFloat(document.getElementById("fee-garantie").value) || 0;
                const timbre = parseFloat(document.getElementById("timbre-fiscal").value) || 0;

                const feesTotal = transport + installation + frais + garantie; // Positive fees

                // Grand Totals
                // totalHT and totalTVA are calculated from lines.
                // We need to present them clearly.
                // Mytek invoice structure usually: 
                // Subtotal (Total HT presumably? or Total TTC lines?). 
                // Let's assume standard Tunisian invoice:
                // Subtotal usually means Total HT.
                // But our inputs are TTC. 
                // Let's display "Total HT" correctly calculated from back-calc.

                document.getElementById("subtotal").textContent = totalHT.toFixed(3);
                document.getElementById("tva").textContent = totalTVA.toFixed(3);
                document.getElementById("fees-total").textContent = feesTotal.toFixed(3);
                document.getElementById("timbre-display").textContent = timbre.toFixed(3);

                // TTC = (Total HT + Total TVA) + Fees + Timbre - Retenue
                // Note: (Total HT + Total TVA) is essentialy sum of row totals (which are TTC).
                const totalTTC = (totalHT + totalTVA) + feesTotal + timbre - retenue;

                document.getElementById("total").textContent = totalTTC.toFixed(3) + " DNT";
            }

            function updateInvItem(idx, field, val) {
                if (field === "qty") {
                    let v = parseInt(val) || 1;
                    if (v < 1) v = 1;
                    // Check stock
                    const available = currentInvoice[idx].stock;
                    // Note: If editing, stock might be complicated. For now simple check.
                    if (v > available) { alert("Max stock request exceeded (" + available + ")"); v = available; }
                    currentInvoice[idx].quantity = v;
                }
                if (field === "color") currentInvoice[idx].selectedColor = val;
                if (field === "disc") currentInvoice[idx].discount = parseFloat(val) || 0;
                if (field === "tva") currentInvoice[idx].tvaRate = parseFloat(val) || 0;

                renderInvoiceEditorTable();
            }

            function removeInvItem(idx) {
                currentInvoice.splice(idx, 1);
                renderInvoiceEditorTable();
            }

            function cancelInvoiceEditor() {
                if (confirm("Discard unsaved changes?")) {
                    currentInvoice = [];
                    editMode = false;
                    editingInvoiceIndex = -1;
                    document.getElementById("invoice-editor").style.display = "none";
                    document.getElementById("tab-stock").style.display = "flex"; // Ensure stock comes back
                }
            }

            // --- VALIDATION & SAVING ---
            async function validateInvoice() {
                if (currentInvoice.length === 0) return alert("Invoice is empty!");

                // Capture Data
                const invData = {
                    number: document.getElementById("invoice-id").value,
                    date: new Date().toLocaleString(),
                    clientEmail: document.getElementById("client-name").value,  // used for client lookup
                    company: {
                        name: document.getElementById("company-name").value,
                        phone: document.getElementById("company-phone").value,
                        address: document.getElementById("company-address").value,
                        fax: document.getElementById("company-fax").value,
                        email: document.getElementById("company-email").value,
                        website: document.getElementById("company-website").value,
                        mf: document.getElementById("company-mf").value,
                        rc: document.getElementById("company-rc").value,
                        rib: document.getElementById("company-rib").value,
                        logo: document.getElementById("company-logo").value
                    },
                    client: {
                        name: document.getElementById("client-name").value,
                        phone: document.getElementById("client-phone").value,
                        address: document.getElementById("client-address").value,
                        code: document.getElementById("client-code").value,
                        mfcin: document.getElementById("client-mfcin").value,
                        ref: document.getElementById("client-ref").value
                    },
                    meta: {
                        payment: document.getElementById("payment-mode").value,
                        chargedTo: document.getElementById("charged-to").value
                    },
                    fees: {
                        transport: parseFloat(document.getElementById("fee-transport").value) || 0,
                        installation: parseFloat(document.getElementById("fee-installation").value) || 0,
                        frais: parseFloat(document.getElementById("fee-frais").value) || 0,
                        retenue: parseFloat(document.getElementById("fee-retenue").value) || 0,
                        garantie: parseFloat(document.getElementById("fee-garantie").value) || 0,
                        timbre: parseFloat(document.getElementById("timbre-fiscal").value) || 0
                    },
                    items: JSON.parse(JSON.stringify(currentInvoice))
                };

                // Calculate final totals for generic view
                let rawTotal = 0;
                invData.items.forEach(i => {
                    rawTotal += (i.price * i.quantity * (1 - (i.discount || 0) / 100));
                });
                const feesSum = invData.fees.transport + invData.fees.installation + invData.fees.frais + invData.fees.garantie;
                const grandTotal = rawTotal + feesSum + invData.fees.timbre - invData.fees.retenue;
                invData.totalTTC = grandTotal;

                // Stock Handling
                // 1. If editing, restore old stock
                if (editMode && editingInvoiceIndex !== -1) {
                    const old = invoices[editingInvoiceIndex];
                    old.items.forEach(oldItem => {
                        const p = products.find(x => x.id === oldItem.id);
                        if (p) p.stock += oldItem.quantity;
                    });
                }
                // 2. Deduct new stock
                invData.items.forEach(newItem => {
                    const p = products.find(x => x.id === newItem.id);
                    if (p) p.stock -= newItem.quantity;
                });
                await saveProducts();
                renderStockTable();

                // Save Invoice to Firestore
                if (editMode && editingInvoiceIndex !== -1) {
                    invoices[editingInvoiceIndex] = invData;
                } else {
                    invoices.push(invData);
                }
                try {
                    await saveOneInvoice(invData);
                } catch (e) { alert('Error saving invoice to cloud: ' + e.message); return; }

                // Cleanup
                editMode = false;
                editingInvoiceIndex = -1;
                currentInvoice = [];
                document.getElementById("invoice-editor").style.display = "none";
                switchTab("invoices");
                renderInvoiceHistory();
                alert("Invoice Saved to Cloud Successfully! ☁️");
            }

            // --- HISTORY & PRINTING ---
            function renderInvoiceHistory() {
                const tbody = document.getElementById("invoice-body");
                tbody.innerHTML = "";
                const term = document.getElementById("invoice-search-bar").value.toLowerCase();

                invoices.forEach(inv => {
                    // Search filter
                    const searchStr = (inv.number + inv.client.name + inv.date).toLowerCase();
                    if (term && !searchStr.includes(term)) return;

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
      <td>${inv.number}</td>
      <td>${inv.date}</td>
      <td>${inv.client.name}</td>
      <td>${inv.items.length}</td>
      <td><b>${(inv.totalTTC || 0).toFixed(3)}</b></td>
      <td>
        <button onclick="printInvoice('${inv.number}')">Print</button>
        <button onclick="editInvoice('${inv.number}')" style="background:#2196F3;">Edit</button>
        <button onclick="cancelInvoice('${inv.number}')" class="cancel-btn">Cancel</button>
      </td>
    `;
                    tbody.appendChild(tr);
                });
            }

            async function cancelInvoice(num) {
                if (prompt("Admin Password:") !== ADMIN_PASSWORD) return;
                const idx = invoices.findIndex(i => i.number === num);
                if (idx === -1) return;

                if (confirm("Cancel this invoice? Stock will be restored.")) {
                    const inv = invoices[idx];
                    // Restore stock
                    inv.items.forEach(item => {
                        const p = products.find(x => x.id === item.id);
                        if (p) p.stock += item.quantity;
                    });
                    await saveProducts();
                    // Remove from Firestore
                    if (inv._docId) {
                        try { await deleteDoc(doc(db, "invoices", inv._docId)); } catch (e) { }
                    } else {
                        const docId = inv.number.replace(/[^a-zA-Z0-9-_]/g, '_');
                        try { await deleteDoc(doc(db, "invoices", docId)); } catch (e) { }
                    }
                    invoices.splice(idx, 1);
                    renderStockTable();
                    renderInvoiceHistory();
                }
            }

            function editInvoice(num) {
                const inv = invoices.find(i => i.number === num);
                if (!inv) return;

                editMode = true;
                editingInvoiceIndex = invoices.findIndex(i => i.number === num);

                // Load data
                currentInvoice = JSON.parse(JSON.stringify(inv.items));
                document.getElementById("invoice-id").value = inv.number;

                // Map fields
                if (inv.company) {
                    document.getElementById("company-name").value = inv.company.name || "";
                    document.getElementById("company-phone").value = inv.company.phone || "";
                    document.getElementById("company-address").value = inv.company.address || "";
                    document.getElementById("company-fax").value = inv.company.fax || "";
                    document.getElementById("company-email").value = inv.company.email || "";
                    document.getElementById("company-website").value = inv.company.website || "";
                    document.getElementById("company-mf").value = inv.company.mf || "";
                    document.getElementById("company-rc").value = inv.company.rc || "";
                    document.getElementById("company-rib").value = inv.company.rib || "";
                    document.getElementById("company-logo").value = inv.company.logo || "";
                    document.getElementById("logo-preview").src = inv.company.logo || "";
                }

                if (inv.client) {
                    document.getElementById("client-name").value = inv.client.name || "";
                    document.getElementById("client-phone").value = inv.client.phone || "";
                    document.getElementById("client-address").value = inv.client.address || "";
                    document.getElementById("client-code").value = inv.client.code || "";
                    document.getElementById("client-mfcin").value = inv.client.mfcin || "";
                    document.getElementById("client-ref").value = inv.client.ref || "";
                }

                if (inv.meta) {
                    document.getElementById("payment-mode").value = inv.meta.payment || "CAISSE";
                    document.getElementById("charged-to").value = inv.meta.chargedTo || "";
                }

                if (inv.fees) {
                    document.getElementById("fee-transport").value = inv.fees.transport || 0;
                    document.getElementById("fee-installation").value = inv.fees.installation || 0;
                    document.getElementById("fee-frais").value = inv.fees.frais || 0;
                    document.getElementById("fee-retenue").value = inv.fees.retenue || 0;
                    document.getElementById("fee-garantie").value = inv.fees.garantie || 0;
                    document.getElementById("timbre-fiscal").value = inv.fees.timbre || 1.000;
                }

                document.getElementById("tab-stock").style.display = "flex"; // Side by side editing
                document.getElementById("tab-invoices").style.display = "none";
                document.getElementById("invoice-editor").style.display = "flex";

                renderInvoiceEditorTable();
            }

            function printInvoice(num) {
                const inv = invoices.find(i => i.number === num);
                if (!inv) return;

                // Safe helpers
                const fmt = (n) => (n || 0).toFixed(3);
                const cmp = inv.company || {};
                const cli = inv.client || {};
                const meta = inv.meta || {};
                const fees = inv.fees || {};

                // Calculate Totals for Print
                let totalHT = 0;
                let totalTVA = 0;

                const taxStats = {};

                const itemsHtml = inv.items.map(item => {
                    const qty = item.quantity;
                    const price = item.price;
                    const disc = item.discount || 0;
                    const rate = item.tvaRate || 19;

                    // Line Calcs
                    const rowTotal = price * qty * (1 - disc / 100);
                    const baseHT = rowTotal / (1 + rate / 100);
                    const tvaVal = rowTotal - baseHT;

                    totalHT += baseHT;
                    totalTVA += tvaVal;

                    if (!taxStats[rate]) taxStats[rate] = { base: 0, tva: 0 };
                    taxStats[rate].base += baseHT;
                    taxStats[rate].tva += tvaVal;

                    return "<tr>" +
                        "<td>" + item.name + "</td>" +
                        "<td>" + item.id + "</td>" +
                        "<td>" + item.name + (item.selectedColor ? "(" + item.selectedColor + ")" : "") + "</td>" +
                        "<td style='text-align:center'>" + qty + "</td>" +
                        "<td style='text-align:right'>" + price.toFixed(3) + "</td>" +
                        "<td style='text-align:center'>" + disc + "%</td>" +
                        "<td style='text-align:right'>" + rowTotal.toFixed(3) + "</td>" +
                        "<td style='text-align:center'>" + rate + "%</td>" +
                        "</tr>";
                }).join("");

                const feesSum = (fees.transport || 0) + (fees.installation || 0) + (fees.frais || 0) + (fees.garantie || 0);
                const grandTotal = totalHT + totalTVA + feesSum + (fees.timbre || 0) - (fees.retenue || 0);

                // Integer / Decimal for Words
                const intPart = Math.floor(grandTotal);
                const decPart = Math.round((grandTotal - intPart) * 1000);

                const taxTableHtml = Object.keys(taxStats).map(k =>
                    "<tr>" +
                    "<td>" + (taxStats[k].base + taxStats[k].tva).toFixed(3) + " (TTC incl.)</td>" +
                    "<td>" + taxStats[k].base.toFixed(3) + "</td>" +
                    "<td>" + k + "%</td>" +
                    "<td>" + taxStats[k].tva.toFixed(3) + "</td>" +
                    "</tr>"
                ).join("");

                // Print Window
                const w = window.open("", "PrintInvoice", "width=800,height=900");
                if (!w) return alert("Popup blocked!");

                var html = "<html><head><title>" + inv.number + "</title>";
                html += "<style>";
                html += "body { font-family:'Arial Narrow', sans-serif; font-size:12px; margin:20px; }";
                html += "table { width:100%; border-collapse:collapse; }";
                html += "td, th { border:1px solid #000; padding:4px; }";
                html += ".no-border td { border:none; }";
                html += ".header-box { display:flex; justify-content:space-between; margin-bottom:20px; }";
                html += ".title-box { border:1px solid #000; padding:5px; background:#ddd; font-weight:bold; margin:10px 0; display:flex; justify-content:space-between; }";
                html += ".footer { margin-top:30px; font-size:10px; }";
                html += "</style>";
                html += "</head><body>";

                // HEADER
                html += "<div class='header-box'>";
                html += "<div style='width:55%'>";
                if (cmp.logo) html += "<img src='" + cmp.logo + "' style='max-height:60px; margin-bottom:10px;'>";
                html += "<div style='font-size:16px; font-weight:bold; text-transform:uppercase;'>" + (cmp.name || "") + "</div>";
                html += "<div>" + (cmp.address || "") + "</div>";
                html += "<div>Tel: " + (cmp.phone || "") + " Fax: " + (cmp.fax || "") + "</div>";
                html += "<div>" + (cmp.email || "") + "</div>";
                html += "<div style='margin-top:5px; font-size:11px;'>Ref: " + inv.number + " / Date: " + (inv.date || '').split(',')[0] + "</div>";
                html += "</div>";
                html += "<div style='width:40%; border:1px solid #000; padding:10px; border-radius:4px;'>";
                html += "<div style='border-bottom:1px solid #000; font-weight:bold; margin-bottom:5px;'>LIVRÉ À:</div>";
                html += "<div style='font-weight:bold; font-size:14px;'>" + (cli.name || "") + "</div>";
                html += "<div>" + (cli.address || "") + "</div>";
                html += "<div>Code: " + (cli.code || "") + "</div>";
                html += "<div>MF/CIN: " + (cli.mfcin || "") + "</div>";
                html += "<div style='margin-top:10px;'>Mode: <b>" + (meta.payment || "") + "</b></div>";
                html += "</div></div>";

                html += "<div class='title-box'>";
                html += "<span>BON DE LIVRAISON / FACTURE</span>";
                html += "<span>" + inv.number + "</span>";
                html += "</div>";

                html += "<table style='margin-bottom:15px; text-align:center;'>";
                html += "<tr style='background:#eee;'><td>Date</td><td>Numéro</td><td>Client Ref</td><td>Chargé(e)</td></tr>";
                html += "<tr>";
                html += "<td>" + inv.date + "</td>";
                html += "<td>" + inv.number + "</td>";
                html += "<td>" + (cli.ref || "") + "</td>";
                html += "<td>" + (meta.chargedTo || "") + "</td>";
                html += "</tr></table>";

                html += "<table>";
                html += "<thead style='background:#eee;'><tr><th>Ref</th><th>Code</th><th>Désignation</th><th>Qté</th><th>PU TTC</th><th>Remise</th><th>Montant</th><th>TVA</th></tr></thead>";
                html += "<tbody>" + itemsHtml + "</tbody>";
                html += "</table>";

                // FEES ROW
                html += "<div style='border:1px solid #000; border-top:none; padding:5px; display:flex; justify-content:space-around; font-size:11px;'>";
                html += "<span>Transport: " + fmt(fees.transport) + "</span>";
                html += "<span>Installation: " + fmt(fees.installation) + "</span>";
                html += "<span>Frais: " + fmt(fees.frais) + "</span>";
                html += "<span>Retenue: " + fmt(fees.retenue) + "</span>";
                html += "<span>Garantie: " + fmt(fees.garantie) + "</span>";
                html += "</div>";

                html += "<div style='display:flex; justify-content:space-between; margin-top:20px;'>";
                html += "<div style='width:55%'>";
                html += "<table style='font-size:11px;'>";
                html += "<tr style='background:#eee;'><th>Total HT</th><th>Base TVA</th><th>Taux</th><th>Mont TVA</th></tr>";
                html += taxTableHtml;
                html += "</table>";
                html += "<div style='margin-top:15px; font-style:italic;'>";
                html += "Arrêtée la présente facture à la somme de:<br>";
                html += "<b>" + intPart + " Dinars et " + decPart + " Millimes.</b>";
                html += "</div></div>";

                html += "<div style='width:40%'>";
                html += "<table style='font-weight:bold;'>";
                html += "<tr><td>Total HT</td><td style='text-align:right;'>" + totalHT.toFixed(3) + "</td></tr>";
                html += "<tr><td>Total TVA</td><td style='text-align:right;'>" + totalTVA.toFixed(3) + "</td></tr>";
                html += "<tr><td>Timbre Fiscal</td><td style='text-align:right;'>" + fmt(fees.timbre) + "</td></tr>";
                html += "<tr style='background:#ddd; font-size:14px;'><td>NET Ã€ PAYER TTC</td><td style='text-align:right;'>" + grandTotal.toFixed(3) + "</td></tr>";
                html += "</table></div></div>";

                // Footer
                html += "<div class='footer'>";
                html += "<div style='border-top:1px solid #000; padding-top:5px; display:flex; justify-content:space-between;'>";
                html += "<div style='width:60%'>";
                html += "<b>Infos Légales:</b><br>";
                html += "MF: " + (cmp.mf || "") + " | RC: " + (cmp.rc || "") + " | RIB: " + (cmp.rib || "") + "<br>";
                html += "IMPORTANT: Marchandise reçue conforme...";
                html += "</div>";
                html += "<div style='text-align:right;'>Signature & Cachet<div style='border:1px solid #ccc; height:60px; width:150px; margin-top:5px;'></div></div>";
                html += "</div></div>";

                // Closing tags - split to avoid parser issues
                html += "<" + "/body><" + "/html>";

                w.document.write(html);
                w.document.close();
                w.setTimeout(() => w.print(), 500);
            }

            // ========================================
            // EXPOSE ALL FUNCTIONS TO GLOBAL SCOPE
            // ========================================
            window.saveAllStocks = saveAllStocks;
            window.exportCSV = exportCSV;
            window.switchTab = switchTab;
            window.startInvoice = startInvoice;
            window.renderInvoiceEditorTable = renderInvoiceEditorTable;
            window.updateInvItem = updateInvItem;
            window.removeInvItem = removeInvItem;
            window.renderInvoiceHistory = renderInvoiceHistory;
            window.deleteProduct = deleteProduct;
            window.addToInvoice = addToInvoice;
            window.validateInvoice = validateInvoice;
            window.printInvoice = printInvoice;
            window.editInvoice = editInvoice;
            window.cancelInvoice = cancelInvoice;
            window.cancelInvoiceEditor = cancelInvoiceEditor;
            window.renderStockTable = renderStockTable;
            window.loadFromFirestore = loadFromFirestore;
            window.saveProducts = saveProducts;
            window.saveOneInvoice = saveOneInvoice;
            window.sanitizeDocId = sanitizeDocId;
            window.findUserByEmail = findUserByEmail;

        </script>
</body>

</html>